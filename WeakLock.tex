\subsection{Алгоритм мягкой блокировки}

Алгоритм мягкой блокировки действует аналогично алгоритму обязательной блокировки, но в случае если наш поток не является первым в очереди блокировка считается не взятой и возвращается соответствующий вердикт.

\begin{lstlisting}[language=csh,caption={Алгоритм Cassandra.TryGetLock(lockId, threadId)}]
  1.  |Если в основной строке есть хотя бы одна запись|
  2.  	|Вернуть false|
  3.  |Добавить поток в очередь|
  4.  |Если наш поток - первый в очереди:|
  5.  	|Добавить ячейку в основную строку|
  6.  	|Если в основной строке есть только одна запись:|
  7.  		|Вернуть true|
  8.  	|Иначе:|
  9.  		|Удалить свою ячейку из основной строки|
 10.  		|Перейти к шагу 4|
 11.  |Иначе:|
 12.  	|Удалить свой поток из очереди|
 13.  	|Вернуть false|
\end{lstlisting}

\begin{theorem}
В ходе выполнения алгоритма Cassandra.TryGetLock несколькими потоками блокировку сможет взять не более одного потока.
\end{theorem}
\textbf{Доказательство:}
Эта теорема доказывается ровно так же, как и теорема 1, так как условие успешного взятия блокировки то же самое, что и в алгоритме обязательной блокировки: поток записался в основную строку и оказался в ней один.
$\Box$

\begin{theorem}
В ходе выполнения алгоритма Cassandra.TryGetLock несколькими потоками хотя бы один поток захватит блокировку.
\end{theorem}
\textbf{Доказательство:}
Заметим, что за конечное время система придет в состояние, в котором первый поток в очереди не изменится: в силу неубывания времени перед всеми в очередь смогут встать либо потоки, имеющие ту же отметку времени, что и текущий первый в очереди, либо потоки, у которых произошла задержка между взятием времени и постановкой в очередь. Очевидно, что этих потоков конечное число, следовательно, время их постановки в очередь тоже конечно.
Предположим, что блокировку не удалось захватить ни одному из потоков. В частности, это означает, что блокировку не смог взять поток, стоящий первый в очереди. По построению алгоритма этот поток будет выполнять строки 4~---10 до тех пор, пока в основной строке будет находиться записи других потоков. Так как поток является первым в очереди, остальные потоки не будут пытаться записаться в основную таблицу, как только увидят этот поток в очереди. Следовательно, рано или поздно основная строка будет пуста, отсюда следует что первый в очереди поток успешно возьмет блокировку.
$\Box$
