\subsection{Алгоритм мягкой блокировки}

Алгоритм мягкой блокировки действует аналогично алгоритму обязательной блокировки, но в случае если наш поток не является первым в очереди блокировка считается не взятой и возвращается соответствующий вердикт.

\begin{lstlisting}[language=csh,caption={Алгоритм Cassandra.TryGetLock(lockId, threadId)}]
  1.  |Если в основной строке есть хотя бы одна запись|
  2.  	|Вернуть false|
  3.  |Добавить поток в очередь|
  4.  |Если наш поток - первый в очереди:|
  5.  	|Добавить ячейку в основную строку|
  6.  	|Если в основной строке есть только одна запись:|
  7.  		|Вернуть true|
  8.  	|Иначе:|
  9.  		|Удалить ячейку из основной строки|
 10.  		|Перейти к шагу 4|
 11.  |Иначе:|
 12.  	|Удалить поток из очереди|
 13.  	|Вернуть false|
\end{lstlisting}

\begin{theorem}
В ходе выполнения алгоритма Cassandra.TryGetLock несколькими потоками блокировку сможет взять не более одного потока.
\end{theorem}
\textbf{Доказательство:}
Взятие блокировки двумя потоками означало бы, что они оба записались в одну строку, прочитали ее и увидели бы по одной записи. Невозможность этого доказана в теореме 1.
$\Box$

\begin{theorem}
В ходе выполнения алгоритма Cassandra.TryGetLock несколькими потоками хотя бы один поток захватит блокировку.
\end{theorem}
\textbf{Доказательство:}
Предположим, что блокировку не удалось захватить ни одному из потоков. В частности это означает, что блокировку не смог взять поток, стоящий первый в очереди. По построению алгоритма этот поток будет выполнять строки 4-10 до тех пор, пока в основной таблице будет кто-нибудь находиться. Так как поток является первым в очереди, остальные потоки не будут пытаться записаться в основную таблицу как только увидят этот поток в очереди. Следовательно, рано или поздно основная таблица будет пуста, отсюда следует что первый в очереди поток успешно возьмет блокировку.
$\Box$

Из теорем 2 и 3 естесственным образом вытекает
\begin{theorem}
В ходе выполнения алгоритма Cassandra.TryGetLock несколькими потоками блокировку возьмет ровно один поток.
\end{theorem}